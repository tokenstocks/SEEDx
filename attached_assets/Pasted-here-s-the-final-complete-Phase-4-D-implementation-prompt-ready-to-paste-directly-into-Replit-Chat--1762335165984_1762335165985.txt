hereâ€™s the final complete Phase 4-D implementation prompt (ready to paste directly into Replit Chat).
It includes sample seed data for LP orders, mock cashflows, and an automated regeneration cycle so you can demo the full regenerative finance loop live.

ğŸ§© PHASE 4-D â€” Regenerative Loop + Marketplace + LP Lock & Analytics
ğŸ¯ Objectives

Extend the regenerative finance platform with:

Automated loop to distribute verified cashflows into treasury + LP revenue.

Token Marketplace (simulated liquidity exchange between investors).

LP Lock Policy controls & Analytics dashboard.

Demo seed data for marketplace and treasury growth.

âš™ï¸ 1. Automated Regenerative Loop

Backend

Add file server/jobs/regenerativeLoop.ts

Create endpoint GET /api/system/run-regeneration

Loop logic:

Fetch project_cashflows where verified = true AND processed = false.

Allocate:

60 % â†’ treasury_pool_transactions (type: â€œrevenueâ€)

20 % â†’ lp_cashflow_allocations (type: â€œlp_shareâ€)

10 % â†’ project_funding (type: â€œreinvestâ€)

10 % â†’ treasury_pool_transactions (type: â€œfeeâ€)

Recompute NAV for each project and create audit record.

Mark each cashflow as processed = true.

Frontend

On /admin/treasury:

Add â€œRun Regenerationâ€ button (visible to superAdmin).

Show modal confirmation + progress indicator + toast results.

ğŸ’± 2. Internal Marketplace (Simulated Liquidity)

Database table token_orders

Column	Type	Notes
id	uuid	PK
userId	FK â†’ users	
projectId	FK â†’ projects	
orderType	enum(buy,sell)	
tokenAmount	decimal(18,6)	
pricePerToken	decimal(18,6)	
status	enum(open,filled,cancelled)	
createdAt	timestamp	
updatedAt	timestamp	

Endpoints

POST /api/marketplace/orders/create

GET /api/marketplace/orders/list?projectId=

POST /api/marketplace/orders/match â€“ auto-matches opposing orders at NAV price, updates balances, logs audit.

Frontend /marketplace

Tabs: Order Book, My Orders, Trade History

Components:

Buy/Sell form (pre-filled with latest NAV)

Order book table with live bids/asks

Trade confirmation modal

Navbar link for LP and Investor roles.

ğŸ”’ 3. LP Lock Policy + Analytics Dashboard

Backend

Extend lp_token_holdings: lockPolicy enum('none','timelock','forever'), unlockDate.

Update redemption logic: disallow if forever; auto-unlock timelocks past date (via server/jobs/unlockTimelocks.ts).

Frontend

Admin (Project â†’ LP Allocation form): dropdown for Lock Policy + date picker.

Investor / LP Dashboard:

New Analytics tab showing charts:

Treasury Growth (â‚¦ over time)

LP Earnings by Project

Locked vs Liquid Value

Export buttons (CSV, PDF)

Lock tooltips (green = liquid, yellow = time-locked w/countdown, gray = forever).

ğŸ§± Schema Changes

Add:

token_orders
id, userId, projectId, orderType, tokenAmount, pricePerToken, status, createdAt, updatedAt


Extend:

lp_token_holdings: lockPolicy, unlockDate
project_cashflows: processed (boolean, default false)
treasury_pool_transactions: sourceCashflowId (nullable)


Update drizzle/schema.ts, Zod validators, and TypeScript types.

ğŸ§® 4. Seed Data (For Demo + Charts)

Add migration seed_phase4d.ts to insert demo records:

Cashflows

project	amount	verified	processed	date
Cassava	â‚¦ 2,000,000	true	false	2025-10-28
Rice	â‚¦ 1,500,000	true	false	2025-10-29
Tomato	â‚¦ 1,400,000	true	false	2025-10-30

Token Orders

user	project	orderType	tokens	price	status
Laura Parker	Cassava	sell	1,200	â‚¦ 12.80	open
Michael Okoro	Cassava	buy	800	â‚¦ 12.80	open
Aisha Lawal	Tomato	buy	1,000	â‚¦ 12.50	open

LP Holdings

user	project	liquid	locked	lockPolicy	unlockDate
Laura Parker	Cassava	100 000	50 000	timelock	2025-06-30
Laura Parker	Rice	0	80 000	forever	null
Laura Parker	Tomato	120 000	0	none	null

Running the regenerative loop once will:
â†’ Move 60 % of cashflows to Treasury, 20 % to LP payouts, 10 % to reinvestment, 10 % to fees.
â†’ Trigger NAV updates and visible growth on charts.

âœ… Deliverables
Area	Deliverable	Path
Backend	Regenerative loop cron + endpoint	server/jobs/regenerativeLoop.ts, /api/system/run-regeneration
Backend	Marketplace CRUD + match engine	/api/marketplace/*
Backend	LP auto-unlock job	server/jobs/unlockTimelocks.ts
Frontend	â€œRun Regenerationâ€ button (Admin Treasury)	/admin/treasury
Frontend	Investor Marketplace UI	/marketplace
Frontend	LP Analytics tab + charts	/lp-dashboard
Docs	Update replit.md (Phase 4-D details)	
ğŸ§  Success Criteria

âœ… Cashflows automatically distribute funds per ratios.

âœ… Marketplace matches orders + updates balances.

âœ… LP lock/unlock logic works (flows visible in dashboard).

âœ… Analytics tab shows treasury + LP growth charts.

âœ… All actions audited and TypeScript type-safe